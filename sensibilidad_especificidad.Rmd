---
title: "Analisis de pruebas diagnosticas"
author: "Nicolás Molano González"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output:
  bookdown::html_document2: default
bibliography: references.bib  
---
```{r echo=F, message = FALSE, warning =F}
###see https://bookdown.org/yihui/rmarkdown-cookbook/cross-ref.html for cross reference
###see https://bookdown.org/yihui/bookdown/internationalization.html for _bookdown.yml
rm(list=ls())
list.of.packages <- c("pacman")
new.packages <- list.of.packages[!(list.of.packages %in% installed.packages()[,"Package"])]
if(length(new.packages)) install.packages(new.packages)
library(pacman)
p_load(tidyverse)
p_load(kableExtra)
p_load(knitr)
p_load(ggbeeswarm)
p_load(ggrepel)
p_load(latex2exp)
p_load(epitab)
p_load(epiR)
p_load(pROC)
p_load(plotrix)
p_load(graphics)
p_load(latex2exp)

set.seed(150)
```

# Introducción
En este documento estudiaremos el analisis de pruebas diagnosticas, con enfasis en los significados probabilisticos de medidas como la sensibilidad y especificidad entre otros. Empezaremos nuestra discucion con un ejemplo.

## Prueba diagnostica para cancer

```{r echo=FALSE, results = 'asis',message = FALSE, warning =F}
disp<-rnorm(744,9,2)
disn<-rnorm(842,5,2)

z0<-data.frame(cons=c(disp,disn),Dis=c(rep("Dis+",length(disp)),rep("Dis-",length(disn))))
mroc<-roc(z0[,"Dis"],z0[,"cons"])
best_coords<-coords(mroc, "best", ret=c("threshold", "specificity", "sensitivity"))
z0$Test<-factor(ifelse(z0$cons<best_coords$threshold,"Test-","Test+"))

z0$Dis<-relevel(z0$Dis,ref="Dis+")
z0$Test<-relevel(z0$Test,ref="Test+")
z0<-data.frame(Id=1:nrow(z0),Dis=z0$Dis,Test=z0$Test,cons=z0$cons)

mincons<-min(z0$cons)
maxcons<-max(z0$cons)
examplumb<-seq(mincons,maxcons,length.out=5)%>%round(3)
```

La variable **cons** es la consentracion de la molecula en la sangre de cada uno de los sujetos de prueba. Ahora el investigador se enfrenta a una pregunta fundamental: ¿Cual sera el valor humbral adecuado para determinar si el test se considera Positivo o Negativo?

Un estudainte de doctorado ha propuesto que la precencia de cierta molecula en la sangre es un buen predictor de la presencia de cancer en los pacientes. Para comprobar su hipotesis, el estudiante a desarrollado un experimento en el cual ha tomado muestras de sangre para `r length(disp)` enfermos de cancer (Dis+) y `r length(disn)` sujetos sanos (Dis-). En estas muestras de sangre el estudiante a corrido una prueba especializada de laboratorio para determinar la presencia (Test+) o ausencia (Test-) de la molecula en la sangre.

El Estudiante sujiere que este estudio es importante ya que determinar la presencia o ausencia de la molecula (prueba que denominaremos como prueba diagnostica) es mucho mas economico, rapido y menos invasivo que las pruebas convencionales que se utilisan para diagnosticar el cancer (conjunto de pruebas que se asumen diagnostican la enfermedad sin error y que denominaremos como el estandar de oro). De tal forma que si los resultados de la prueba diagnostica son similares a los del estandar de oro, esta nueva prueba diagnostica podria usarse en ves del estandar de oro reduciondo costos, aumentando la velocidad de las pruebas y evitandole incomodidades al paciente.

A continuacion presentamos una parte de la tabla de datos correspondiente a este experimento (tabla \@ref(tab:pdtab)):

```{r pdtab, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
res<-kable(z0[sample(1:nrow(z0),10,replace =T),1:3],caption="Tabla de datos para el experimento de prueba diagnostica",row.names =F)
kable_styling(res,"striped", position = "center",full_width = F)
```
La columna *Id* es un identificador del sujeto, la variable *Dis* determina si el sujeto tiene o no cancer segun el estandar de oro y la variable *Test* determina el resultado de la prueba diagnostica. Una primera aproximacion al analisis de este experimento sera construir una tabla de contingencia que relacione el estado del sujeto (Dis+ o Dis-) con los resultados de la prueba (Test+ o Test-), ver tabla \@ref(tab:contpdtab).

```{r contpdtab, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
temp_table<-table(z0$Test,z0$Dis)
res2<-kable((temp_table%>%addmargins),caption="Tabla de contingencia Dis vs Test")
kable_styling(res2,"striped", position = "center",full_width = F)
# res<-t(table(z0)%>%addmargins)
# knitr::kable(res,caption="Tabla de contingencia: status vs exposition")
```

Como ustedes podran saber, para este tipo de experimentos existen varios indices de resumen que evaluan la similaridad de la prueba diagnostica con respecto al estandar de oro y estos estan construidos en base a los valores de la tabla de contingencia descrita anteriormente, en la tabla \@ref(tab:pdmtrics) se presenta la nomenclatura de estos conteos.

```{r pdmtrics, echo=FALSE, results = 'asis', message=FALSE}
temp_table2<-matrix(c("TP","FN","FP","TN"),nrow = 2,dimnames = list(c("Test+","Test-"),c("Dis+","Dis-")))
res22<-kable(temp_table2,caption="Tabla de contingencia para pruebas diagnosticas")
kable_styling(res22,"striped", position = "center",full_width = F)
```
 Aqui, **TP** son los verdaderos positivos (true postive), **FN** falsos negativos (False negative), **FP** falsos positivos (False positive) y **TN** los verdaderos negativos (true negative). Para nuestro ejemplo tenemos que $TP=$ `r temp_table[1,1]`, $FN=$ `r temp_table[2,1]`, $FP=$ `r temp_table[1,2]`, $TN=$ `r temp_table[2,2]`.

Con base en esta nomenclatura tenemos las siguientes definiciones:
\begin{equation}
Sensibilidad=\frac{TP}{TP+FN} (\#eq:sens)
\end{equation}

\begin{equation}
Especificidad=\frac{TN}{FP+TN} (\#eq:esp)
\end{equation}

\begin{equation}
Valor\; Predictivo\; Postivo= V.P.P=\frac{TP}{TP+FP} (\#eq:vpp)
\end{equation}

\begin{equation}
Valor\; Predictivo\; Negativo= V.P.N=\frac{TN}{FN+TN} (\#eq:vpn)
\end{equation}

Estas ecuaciones parecen sospechosamente similares al calculo de ciertas probabilidades que estudiamos en el capitulo anterior, de hecho, estas cuatro formulas son en realidad probabilidades condicionales.

# Metricas de diagnostico como probabilidades condicionales

A continuacion demostraraemos que las cuatro metricas anteriormente definidas son en realidad probabilidades condicionales. Empesaremos por definir el tamaño total de la poblacion de estudio como

\begin{equation}
N=TP+FN+FP+TN (\#eq:nsize)
\end{equation}

## Sensibilidad

La ecuacion \@ref(eq:sens) se puede reeescribir como 

$$Sensibilidad=\frac{TP}{TP+FN}=\frac{\frac{TP}{N}}{\frac{TP+FN}{N}} =\frac{P(Test+ \cap  \; Dis+)}{P(Dis+)}= P(Test+|Dis+)$$

Es decir que la sensibilidad corresponde a la probabilidad condicional de obtener un resultado postivo en la prueba diagnostica  dado que se esta verdaderamente enfermo.

## Espesificidad

La ecuacion \@ref(eq:esp) se puede reeescribir como 
$$Especificidad=\frac{TN}{FP+TN}=\frac{\frac{TN}{N}}{\frac{FP+TN}{N}}=\frac{P(Test- \cap  \; Dis-)}{P(Dis-)}=P(Test-|Dis-)$$
Es decir que la espesificidad corresponde a la probabilidad condicional de obtener un resultado negativo en la prueba diagnostica  dado que se esta verdaderamente sano.

## Valor Predictivo Postivo

La ecuacion \@ref(eq:vpp) se puede reeescribir como 
$$V.P.P=\frac{TP}{TP+FP}=\frac{\frac{TP}{N}}{\frac{TP+FP}{N}}=\frac{P(Test+ \cap  \; Dis+)}{P(Test+)}=P(Dis+|Test+)$$

Es decir que el V.P.P. corresponde a la probabilidad condicional de estar verdaderamente enfermo cuando la prueba arroja un resultado positivo. Aqui vale la pena destacar el caracter "predictivo" del indice. Se habla de prediccion ya que estamos interesados en conocer la probabilidad de estar verdaderamente enfermo (segun el estandar de oro) teniendo en cuenta que el resultado del test es positivo. Es decir, se esta evaluado la capacidad predictiva del test en pacientes enfermos.

## Valor Predictivo Negativo

La ecuacion \@ref(eq:vpn) se puede reeescribir como 
$$V.P.N=\frac{TN}{FN+TN}=\frac{\frac{TN}{N}}{\frac{FN+TN}{N}}=\frac{P(Test- \cap  \; Dis-)}{P(Test-)}=P(Dis-|Test-)$$

Es decir que el V.P.N. corresponde a la probabilidad condicional de estar verdaderamente sano cuando la prueba arroja un resultado positivo. Aqui vale la pena destacar el caracter "predictivo" del indice. Se habla de prediccion ya que estamos interesados en conocer la probabilidad de estar verdaderamente sano (segun el estandar de oro) teniendo en cuenta que el resultado del test es negativo. Es decir, se esta evaluado la capacidad predictiva del test en pacientes sanos.

# Otras metricas de evaluacion de desempeño de una prueba diagnostica

Existen otras metricas menos comunes para la evaluacion del desempeño de la prueba diagnostica, por ejemplo el Valor Predictivo Global o tambien denominado Presicion definida como

\begin{equation}
Valor\; Predictivo\; Global= V.P.G=\frac{TP+TN}{N} (\#eq:vpg)
\end{equation}

Esta metrica se puede interpretar como la probabilidad de acierto de la prueba diagnostica.

Para conocer otros indices de evaluacion del desempeño de una prueba diagnostica remitase a @Hajian2013 y @Florkowski2008 por ejemplo.

# Detalles de un estudio de prueba diagnostica

Retomando nuestro ejemplo de prueba diagnostica para cancer, la prueba propuesta consiste en la deteccion de una molecula en la sangre de los sujetos de prueba. Sin embargo, la prueba de laboratorio que se realiza para detectar esta molecula en la sangre de los pacientes no arroja un valor dicotomico como "+" o "-", en realidad arroja una consentracion de la molecula en la sangre, es decir que la verdadera tabla del estudio se ve de esta manera:

```{r pdtabtrue, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html
resT<-kable(z0[sample(1:nrow(z0),10,replace =T),c(1:2,4)],caption="Tabla de datos para el experimento de prueba diagnostica",row.names =F)
kable_styling(resT,"striped", position = "center",full_width = F)
```

Para este caso el valor minimo de la consentracion es `r mincons%>%round(3)` y  el maximo es `r maxcons%>%round(3)`. Esto implica que el investigador debe buscar un numero umbral entre `r mincons%>%round(3)` y  `r maxcons%>%round(3)` para el cual concentraciondes menores a ese umbral determinaran valores negativos de la prueba y complementariametne valores de concentracion superiores a ese umbral determinara un valor positivo en la prueba. Tomemos por ejemplo los siguintes umbrales: `r examplumb` y veamos como se ven los valores de positividad del test en funcion de estos umbrales:

```{r pdtabtrueUMB, echo=FALSE}
###see http://haozhu233.github.io/kableExtra/awesome_table_in_html.html

for(i in seq_along(examplumb)){
  z0[,paste0("Um_",i)]<-factor(ifelse(z0$cons<examplumb[i],"Test-","Test+"),levels = c("Test+","Test-"))
}
resTUMB<-kable(z0[sample(1:nrow(z0),10,replace =T),c(-3)],caption="Tabla de datos para con resultados del test para diferentes umbrales",row.names =F)
kable_styling(resTUMB,"striped", position = "center",full_width = F)
```

donde `r paste0("Um_",1:5," = ",examplumb)`. Notese que, para el primer umbral, todos los resultados son pòsitivos mietras que, para el ultimo umbral todos los resultados son negativos. Claramente para cada umbral se genera una tabla de contingencia (ver \@ref(tab:contresumb)) para la cual se pueden calcular todoas las metricas de desempeño de pruebas diagnosticas (ver \@ref(tab:contresumbdes)).

```{r contresumb, echo=FALSE}
cont_tabl_list<-list()
ana_list<-list()
for(i in paste0("Um_",1:5)){
  cont_tabl_list[[i]]<-table(z0[,i],z0$Dis)
  
  ana_list[[i]]<-epi.tests(cont_tabl_list[[i]])
}

desp_df<-paste0("Um_",1:5)%>%map_df(function(x){
  data.frame(Umb=x,Sens=ana_list[[x]]$rval$se$est,Esp=ana_list[[x]]$rval$sp$est,vpp=ana_list[[x]]$rval$ppv$est,vpn=ana_list[[x]]$rval$npv$est,vpg=ana_list[[x]]$rval$diag.acc$est)
})

cont_tblUMB<-cont_tabl_list%>%reduce(rbind)%>%{cbind(.,UM=rep(paste0("Um_",1:5),each=2))}
resCTUMB<-kable(cont_tblUMB,caption="Tablas de contingencia para diferentes umbrales",row.names =T)
kable_styling(resCTUMB,"striped",full_width = F,position = "center")

```

```{r contresumbdes, echo=FALSE}

depCTUMB<-kable(desp_df,caption="Metricas de desempeño para diferentes umbrales",row.names =T)
kable_styling(depCTUMB,"striped",full_width = F,position = "center")

```

Teniendo esto en cuenta, podria proponer usted cual seria el mejor valor de los 5 umbrales estudiados?

# Espacio ROC

ROC, por sus siglas en ingles (Receiver-Operating Characteristic), traduce al español "Curva operativa del receptor", el desarrollo de esta tecnica de analisis data de los años 50 en el campo de la ingenieria elctrica y el estudio de deteccion de señales. Ver @Hajian2013 para una breve contextualizacion. 

Considere el problema anterior de los 5 umbrales propuestos. Vamos a graficar las medidas de sensibilidad y especificidad en un plano carteciano en donde el eje $x$ corresponde a $1-Esp$ y el eje $y$ corresponde a la $Sens$. Este plano cartesiano con estos ejes se denomina el espacio ROC (figura \@ref(fig:rocg1)B).
<center>
```{r rocg1, message = FALSE, warning =F, echo=F, fig.width=8, fig.height=4, fig.cap="Espacio ROC"}
rocp2<-ggplot(desp_df,aes(x=1-Esp,y=Sens))+
  geom_line()+geom_point()+
  geom_label_repel(aes(label = Umb),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50') +
  theme_bw()+ ggtitle("B) Curva ROC para los 5 umbrales")

rocp1<-ggplot(data.frame(Umb=LETTERS[1:3],Sens=c(0,1,1),Esp=c(1,1,0)),aes(x=1-Esp,y=Sens))+
  geom_point()+
  geom_label_repel(aes(label = Umb),
                  box.padding   = 0.35, 
                  point.padding = 0.5,
                  segment.color = 'grey50') +
  theme_bw()+ ggtitle("A) Puntos destacados en el espacio ROC")

gridExtra::grid.arrange(grobs =list(rocp1,rocp2),nrow=1,ncol=2)
```
</center>

Relacione los puntos en el espacio ROC con los valores de sensibilidad y especifisidad de la tabla \@ref(tab:contresumbdes). En la figura \@ref(fig:rocg1)A Relacionamos tres puntos importantes en el espacio ROC:

* **A** corresponde a 0% sensibilidad y 100% especifisidad
* **B** corresponde a 100% sensibilidad y 100% especifisidad
* **C** corresponde a 100% sensibilidad y 0% especifisidad

Claramente deseamos estar lo mas cerca posible del punto B en donde la prueba diagnositca coinside 100% con el estandar de oro. Este es de hecho un de los criterios para buscar el mejor umbral: econtrar el valor de umbral para el cual se esta mas cerca de la esquina superior izquierda del plano cartesiano del espacio ROC.

# Bibliografia
[comment]: <> (see https://bookdown.org/yihui/rmarkdown-cookbook/bibliography.html)
